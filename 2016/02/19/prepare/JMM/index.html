<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Java 内存模型 | chenchen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="java 的内存模型java memory module    
高速缓存解决了处理器与内存的速度矛盾，但是引入了一个新的问题：缓存一致性(Cache coherence).  
java 内存模型的主要目的是定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量。  

Java 内存模型规定了所有的变量都存储在主内存中，每条线程还有自己的工作内存（与cache类比）">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 内存模型">
<meta property="og:url" content="http://yoursite.com/2016/02/19/prepare/JMM/index.html">
<meta property="og:site_name" content="chenchen">
<meta property="og:description" content="java 的内存模型java memory module    
高速缓存解决了处理器与内存的速度矛盾，但是引入了一个新的问题：缓存一致性(Cache coherence).  
java 内存模型的主要目的是定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量。  

Java 内存模型规定了所有的变量都存储在主内存中，每条线程还有自己的工作内存（与cache类比）">
<meta property="og:image" content="http://images.cnitblog.com/i/475287/201403/091516513623330.png">
<meta property="og:updated_time" content="2016-04-05T01:40:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java 内存模型">
<meta name="twitter:description" content="java 的内存模型java memory module    
高速缓存解决了处理器与内存的速度矛盾，但是引入了一个新的问题：缓存一致性(Cache coherence).  
java 内存模型的主要目的是定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量。  

Java 内存模型规定了所有的变量都存储在主内存中，每条线程还有自己的工作内存（与cache类比）">
  
    <link rel="alternative" href="/atom.xml" title="chenchen" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://news.mydrivers.com/Img/20100622/10062490.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">chenchen</a></h1>
		</hgroup>

		
		<p class="header-subtitle">be all you can be.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/shuandroid" title="github">github</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 16px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 18px;">Android</a> <a href="/tags/Art/" style="font-size: 12px;">Art</a> <a href="/tags/Ashmem/" style="font-size: 10px;">Ashmem</a> <a href="/tags/DPI/" style="font-size: 10px;">DPI</a> <a href="/tags/JVM/" style="font-size: 12px;">JVM</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Library/" style="font-size: 10px;">Library</a> <a href="/tags/Mvvm/" style="font-size: 10px;">Mvvm</a> <a href="/tags/Network/" style="font-size: 14px;">Network</a> <a href="/tags/RecyclerView/" style="font-size: 10px;">RecyclerView</a> <a href="/tags/Style/" style="font-size: 10px;">Style</a> <a href="/tags/Suooprt/" style="font-size: 10px;">Suooprt</a> <a href="/tags/adapter/" style="font-size: 10px;">adapter</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/android，-Network，-volley，-first/" style="font-size: 10px;">android， Network， volley， first</a> <a href="/tags/anim/" style="font-size: 10px;">anim</a> <a href="/tags/animation/" style="font-size: 12px;">animation</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/design/" style="font-size: 12px;">design</a> <a href="/tags/fourth/" style="font-size: 10px;">fourth</a> <a href="/tags/frame/" style="font-size: 10px;">frame</a> <a href="/tags/git-多分支/" style="font-size: 10px;">git 多分支</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/list/" style="font-size: 10px;">list</a> <a href="/tags/material-design/" style="font-size: 10px;">material design</a> <a href="/tags/mk/" style="font-size: 10px;">mk</a> <a href="/tags/netWork/" style="font-size: 10px;">netWork</a> <a href="/tags/recycler/" style="font-size: 10px;">recycler</a> <a href="/tags/resource/" style="font-size: 10px;">resource</a> <a href="/tags/second/" style="font-size: 10px;">second</a> <a href="/tags/square/" style="font-size: 10px;">square</a> <a href="/tags/third/" style="font-size: 10px;">third</a> <a href="/tags/view/" style="font-size: 14px;">view</a> <a href="/tags/volley/" style="font-size: 14px;">volley</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a> <a href="/tags/ybook/" style="font-size: 10px;">ybook</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">做好眼前的事</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">chenchen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://news.mydrivers.com/Img/20100622/10062490.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">chenchen</h1>
			</hgroup>
			
			<p class="header-subtitle">be all you can be.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/shuandroid" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-prepare/JMM" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/19/prepare/JMM/" class="article-date">
  	<time datetime="2016-02-19T08:34:30.000Z" itemprop="datePublished">2016-02-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Java 内存模型
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="java_的内存模型">java 的内存模型</h1><p>java memory module    </p>
<p>高速缓存解决了处理器与内存的速度矛盾，但是引入了一个新的问题：缓存一致性(Cache coherence).  </p>
<p><strong>java 内存模型的主要目的是定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量。</strong>  </p>
<ul>
<li><p>Java 内存模型规定了所有的变量都存储在主内存中，每条线程还有自己的工作内存（与cache类比）  </p>
<p>  线程对变量的所有操作（读取、赋值）都必须在工作内存中进行，而不能直接读写内存中的变量。  </p>
<p>  Java 线程 &lt;——-&gt; 工作内存 &lt;———&gt; sava和<code>load</code>操作 &lt;——-&gt; 主内存  </p>
</li>
</ul>
<h3 id="主内存和工作内存之间的具体交互协议">主内存和工作内存之间的具体交互协议</h3><p>Java 内存模型定义了一下八种操作：  </p>
<ol>
<li>lock ：         ——&gt; 主内存变量， 把一个变量标识为一条线程独占状态  </li>
<li>Unlock ：        ——&gt; 主内存变量， 释放  </li>
<li>read :          ——&gt; 主内存变量， 把一个变量值从内存传送到线程的工作内存 ，便于load 操作  </li>
<li>load :         ——&gt; 工作内存的变量，把read的变量值放入到工作内存的变量副本中  </li>
<li>use ：        ——&gt; 工作内存的变量，工作内存的变量值—&gt; 执行引擎  </li>
<li>assign :     ——&gt; 工作内存的变量, 把从执行引擎得到的值——&gt; 赋给工作内存的变量  </li>
<li>store ：         ——&gt; 工作内存的变量, 传给主内存，便于后面的write操作  </li>
<li>write :        ——&gt; 主内存的变量，把从工作内存的传过来的变量进行write进主内存  </li>
</ol>
<p>Java内存模型只要求上述操作必须按顺序执行，而没有保证必须是连续执行  </p>
<h3 id="重排序">重排序</h3><p>源代码——&gt; 编译器优化重排序 ——&gt; 指令级并行重排序 ——-&gt; 内存系统重排序 ——&gt; 最终执行的指令序列  </p>
<p>为了保证内存的可见性，Java编译器在生成指令序列的适当位置会插入内存屏障指令来禁止特定类型的处理器重排序  </p>
<p>Java内存模型把内存屏障分为LoadLoad、LoadStore、StoreLoad和StoreStore四种：  </p>
<p><img src="http://images.cnitblog.com/i/475287/201403/091516513623330.png" alt="">  </p>
<h3 id="同步机制_：">同步机制 ：</h3><p><strong>volatile , synchronized, final</strong>  </p>
<ol>
<li><p>线程内存访问机制  </p>
</li>
<li><p>volatile 关键字  </p>
<p> 用<code>volatile</code>修饰的变量，线程在每次使用变量的时候，都会读取修改后的最新的值.<br> 对变量的写操作，不依赖于当前值<br> 不能和其他变量同时出现在一个表达式中<br> volatile的作用就是使它修饰的变量的读写操作都必须在内存中进行</p>
</li>
<li><p>synchronized关键字 </p>
<p> 线程同步的内部机制，通过加锁的方式保证线程的可见性和互斥性，<br> 即一个线程的执行结果可以被另一个线程所看到且在同一时间只能有一个线程执行被保护的代码块</p>
</li>
<li><p>final 关键字<br> 与前面的锁和<code>volatile</code>相比较，对<code>final</code>域的读和写更像是普通的变量访问  </p>
<ul>
<li>在构造函数内对一个final域的写入，与随后把这个被构造对象的引用赋值给一个引用变量，这两个操作之间不能重排序。  </li>
<li>初次读一个包含final域的对象的引用，与随后初次读这个final域，这两个操作之间不能重排序  </li>
</ul>
</li>
</ol>
<blockquote>
<p>上面的两条规则其实可分为1.写final域的重排序规则 ：</p>
<ol>
<li>读final域的重排序规则  </li>
</ol>
</blockquote>
<ol>
<li><p>写final域的重排序规则</p>
<ul>
<li>JMM禁止编译器把final域的写重排序到构造函数之外</li>
<li>编译器会在final域的写之后，构造函数return之前，插入一个StoreStore屏障（内存屏障）<br>  这个屏障禁止处理器把final域的写重排序到构造函数之外。</li>
</ul>
</li>
</ol>
<ul>
<li><p>读final域的重排序规则</p>
<ul>
<li>在一个线程中，初次读对象引用与初次读该对象包含的final域，JMM禁止处理器重排序这两个操作<br>  仅针对与处理器（重排序的后两种），<br>  编译器会在读final域操作的前面插入一个LoadLoad屏障</li>
</ul>
</li>
</ul>
<p><strong>volatile与synchronized</strong></p>
<ol>
<li>volatile本质是在告诉jvm当前变量在寄存器中的值是不确定的,需要从主存中读取。</li>
<li>synchronized则是锁定当前变量,只有当前线程可以访问该变量,其他线程被阻塞住.  </li>
<li>volatile仅能使用在变量级别,synchronized则可以使用在变量,方法.  </li>
<li>volatile仅能实现变量的修改可见性,但不具备原子特性,而synchronized则可以保证变量的修改可见性和原子性  </li>
<li>volatile不会造成线程的阻塞,而synchronized可能会造成线程的阻塞.  </li>
<li>volatile标记的变量不会被编译器优化,而synchronized标记的变量可以被编译器优化.  </li>
</ol>
<h3 id="Java最大线程数">Java最大线程数</h3><p>(MaxProcessMemory - JVMMemory - ReservedOsMemory) / (ThreadStackSize) = Number of threads  </p>
<p>MaxProcessMemory 指的是一个进程的最大内存  </p>
<p>JVMMemory         JVM内存  </p>
<p>ReservedOsMemory  保留的操作系统内存  </p>
<p>ThreadStackSize      线程栈的大小  </p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/10/prepare/ashmem/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Ashmem
        
      </div>
    </a>
  
  
    <a href="/2016/02/14/prepare/artOfAndroid/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Android 开发艺术探索</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="prepare/JMM" data-title="Java 内存模型" data-url="http://yoursite.com/2016/02/19/prepare/JMM/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 chenchen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>