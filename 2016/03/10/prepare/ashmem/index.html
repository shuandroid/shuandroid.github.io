<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Ashmem | chenchen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Ashmem Anonymous Shared Memory android 匿名共享内存">
<meta property="og:type" content="article">
<meta property="og:title" content="Ashmem">
<meta property="og:url" content="http://yoursite.com/2016/03/10/prepare/ashmem/index.html">
<meta property="og:site_name" content="chenchen">
<meta property="og:description" content="Ashmem Anonymous Shared Memory android 匿名共享内存">
<meta property="og:updated_time" content="2016-04-05T01:39:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ashmem">
<meta name="twitter:description" content="Ashmem Anonymous Shared Memory android 匿名共享内存">
  
    <link rel="alternative" href="/atom.xml" title="chenchen" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://news.mydrivers.com/Img/20100622/10062490.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">chenchen</a></h1>
		</hgroup>

		
		<p class="header-subtitle">be all you can be.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/shuandroid" title="github">github</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 16px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 18px;">Android</a> <a href="/tags/Art/" style="font-size: 12px;">Art</a> <a href="/tags/Ashmem/" style="font-size: 10px;">Ashmem</a> <a href="/tags/DPI/" style="font-size: 10px;">DPI</a> <a href="/tags/JVM/" style="font-size: 12px;">JVM</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Library/" style="font-size: 10px;">Library</a> <a href="/tags/Mvvm/" style="font-size: 10px;">Mvvm</a> <a href="/tags/Network/" style="font-size: 14px;">Network</a> <a href="/tags/RecyclerView/" style="font-size: 10px;">RecyclerView</a> <a href="/tags/Style/" style="font-size: 10px;">Style</a> <a href="/tags/Suooprt/" style="font-size: 10px;">Suooprt</a> <a href="/tags/adapter/" style="font-size: 10px;">adapter</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/android，-Network，-volley，-first/" style="font-size: 10px;">android， Network， volley， first</a> <a href="/tags/anim/" style="font-size: 10px;">anim</a> <a href="/tags/animation/" style="font-size: 12px;">animation</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/design/" style="font-size: 12px;">design</a> <a href="/tags/fourth/" style="font-size: 10px;">fourth</a> <a href="/tags/frame/" style="font-size: 10px;">frame</a> <a href="/tags/git-多分支/" style="font-size: 10px;">git 多分支</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/list/" style="font-size: 10px;">list</a> <a href="/tags/material-design/" style="font-size: 10px;">material design</a> <a href="/tags/mk/" style="font-size: 10px;">mk</a> <a href="/tags/netWork/" style="font-size: 10px;">netWork</a> <a href="/tags/recycler/" style="font-size: 10px;">recycler</a> <a href="/tags/resource/" style="font-size: 10px;">resource</a> <a href="/tags/second/" style="font-size: 10px;">second</a> <a href="/tags/square/" style="font-size: 10px;">square</a> <a href="/tags/third/" style="font-size: 10px;">third</a> <a href="/tags/view/" style="font-size: 14px;">view</a> <a href="/tags/volley/" style="font-size: 14px;">volley</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a> <a href="/tags/ybook/" style="font-size: 10px;">ybook</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">做好眼前的事</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">chenchen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://news.mydrivers.com/Img/20100622/10062490.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">chenchen</h1>
			</hgroup>
			
			<p class="header-subtitle">be all you can be.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/shuandroid" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-prepare/ashmem" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/10/prepare/ashmem/" class="article-date">
  	<time datetime="2016-03-10T08:34:30.000Z" itemprop="datePublished">2016-03-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Ashmem
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ashmem/">Ashmem</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Ashmem_Anonymous_Shared_Memory_android_匿名共享内存">Ashmem Anonymous Shared Memory android 匿名共享内存</h2><a id="more"></a>
<p>两个特点：</p>
<ol>
<li>能够辅助内存管理系统来有效的管理不再使用的内存块</li>
<li>通过Binder进程间通信机制来实现进程间的内存共享。</li>
</ol>
<p>Android系统的匿名共享内存子系统的主体是以驱动程序的形式实现在内核空间的。</p>
<blockquote>
<p>应用程序框架层的Java调用接口是通过JNI方法来调用库层的C/C++调用接口<br>android应用程序框架层提供了一个MemoryFile接口来封装了匿名共享内存文件的创建和使用<br>它实现在<code>frameworks/base/core/java/android/os/MemoryFIle.java</code>文件中</p>
</blockquote>
<p>MemoryFile.java 的构造函数：(两种创建匿名共享内存的方法)</p>
<pre><code><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryFile</span> </span>{
    ...
    <span class="function"><span class="keyword">public</span> <span class="title">MemoryFile</span><span class="params">(String name, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException </span>{
        mLength = length;
        mFD = native_open(name, length);
        mAddress = native_mmap(mFD, length, PROT_READ | PROT_WRITE);
        mOwnsRegion = <span class="keyword">true</span>;
    }
    ...
    <span class="function"><span class="keyword">public</span> <span class="title">MemoryFile</span><span class="params">(FileDescriptor fd, <span class="keyword">int</span> length, String mode)</span> <span class="keyword">throws</span> IOException </span>{
        <span class="keyword">if</span> (fd == <span class="keyword">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"File descriptor is null"</span>)
        }
        <span class="keyword">if</span> (!isMemoryFile(fd)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> ILlegalArgumentException(<span class="string">"Not a memory file."</span>);
        }
        mLength = length;
        mFD = fd;
        mAddress = native_mmap(mFD, length, modeToProt(mode));
        mOwnsRegion = <span class="keyword">false</span>;
    }
    ...
}
</code></pre><p>第一种方法是以指定的字符串调用jni方法<code>native_open()</code>来创建一个匿名共享内存文件，得到<code>mFD</code>文件描述符， 把其传入进<code>native_mmap()</code>映射在进程空间中，便可以通过这个映射得到的地址空间来直接访问内存数据。<br>第二种则是以指定的文件描述符来直接调用JNI方法<code>native_mmap(...)</code>把这个匿名共享内存文件映射在进程空间中，然后进行访问。要判断该fd是否为匿名共享内存文件的文件描述符<code>isMemoryFile(fd)</code></p>
<h4 id="具有辅助内存管理系统来有效的管理内存的特点">具有辅助内存管理系统来有效的管理内存的特点</h4><blockquote>
<p>Ashmem 驱动程序的源代码<br>ashmem机制是建立在Linux内核实现的共享内存的基础上的，同时向Linux内存管理系统的内存回收算法注册接口，告诉linux内存管理系统它的某些内存块不再使用了，可以被回收了。</p>
</blockquote>
<h4 id="MemoryFile接口">MemoryFile接口</h4><p>创建(<code>open</code>), 映射(<code>mmap</code>), 读写(<code>read/write</code>)以及锁定和解锁(<code>pin/unpin</code>)四个使用场景<br><strong>先看Ashmem驱动程序模块的初始化函数</strong><br>ashmem驱动程序实现在kernel/common/mm/ashmem.c文件中，初始化函数为<code>ashmem_init</code></p>
<pre><code>static struct file_operations <span class="variable">ashmem_fops =</span> {
    .<span class="variable">owner =</span> THIS_MODULE,
    .<span class="variable">open =</span> ashmem_open,
    .<span class="variable">release =</span> ashmem_release,
    .<span class="variable">mmap =</span> ashmem_mmap,
    .<span class="variable">unlocked_ioctl =</span> ashmem_ioctl,
    .<span class="variable">compat_ioctl =</span> ashmem_ioctl,
};

static struct miscdevice <span class="variable">ashmem_misc =</span> {
    .<span class="variable">minor =</span> MISC_DYNAMIC_MINOR,
    .<span class="variable">name =</span> <span class="string">"ashmem"</span>,
    .<span class="variable">fops =</span> &amp;ashmem_fops,
};

static int __init ashmem_init(void)  {
    int ret;
    ......

    <span class="variable">ret =</span> misc_register(&amp;ashmem_misc);
    <span class="keyword">if</span> (unlikely(ret)) {
        printk(KERN_ERR <span class="string">"ashmem: failed to register misc device!\n"</span>);
        return ret;
    }
    ......

    return <span class="number">0</span>;
}
</code></pre><p><strong>匿名共享内存的创建过程(open)</strong><br>在<code>MemoryFile</code>第一个构造函数中通过JNI的<code>native_open</code>来创建，<br>而这个方法的实现在<code>frameworks/base/core/jni/adroid_os_MemoryFile.cpp</code>,<br>在里面又会调用<code>ashmem_create_region()</code>来创建匿名共享内存，这个函数实现在<br><code>system/core/libcutils/ashmem-dev.c</code>文件中，在region()中会先open,<br>然后两次<code>ioctl</code>, open()是打开设备文件ASHMEM_DEVICE, 后面的分别是设置匿名共享内存的名称和大小。</p>
<blockquote>
<p><code>struct ashmem_area</code> 它是Ashmem驱动程序的一个相关数据结构，用于表示一块共享内存。<br>它的实例都是从自定义的一个slab缓冲区(是在初始化函数创建的)创建的</p>
</blockquote>
<p>在region函数里面(open函数):</p>
<pre><code><span class="comment">//执行打开文件的操作</span>
fd = <span class="keyword">open</span>(ASHMEM_DIVICE, O_RDWR);
<span class="comment">//ASHMEM_DIVICE是个宏，定义为: #define ASHMEM_DIVICE "/dev/ashmem"(共享内存设备文件)</span>
</code></pre><p>iconl函数：</p>
<pre><code><span class="comment">//调用两次iconl，匿名共享内存的名称和大小</span>
<span class="comment">//在kernel/common/mm/include/ashmem.h文件中，</span>
<span class="hexcolor">#def</span>ine ASHMEM_NAME_LEN <span class="number">256</span>
<span class="hexcolor">#def</span>ine __ASHMEMIOC <span class="number">0</span>x77
<span class="hexcolor">#def</span>ine ASHMEM_SET_NAME _IOW(__ASHMEMIOC, <span class="number">1</span>, char[ASHMEM_NAME_LEK])
<span class="hexcolor">#def</span>ine ASHMEM_SET_SIZE _IOW(__ASHMEMIOC, <span class="number">3</span>, size_t)
</code></pre><p>ASHMEM_SET_NAME 命令的iconl调用，最终进入到Ashmem驱动程序的ashmem_iconl函数中， 依次调用<code>set_name()</code>,将名字映射到<code>asma-&gt;name</code>中；<br>同理ASHMEME_SET_SIZE，将大小保存在对应的<code>asma-&gt;size</code>域中</p>
<blockquote>
<p>ashmem的创建完成</p>
</blockquote>
<h4 id="ashmem_的内存映射操作(mmap)">ashmem 的内存映射操作(mmap)</h4><p>在<code>MemoryFile</code>类的构造函数中， 进行了匿名共享内存的创建操作后，然后就是要把匿名共享内存设备文件映射到空间中：</p>
<pre><code><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryFile</span> </span>{
    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">native_mmap</span><span class="params">(FileDescriptor fd, <span class="keyword">int</span> length, <span class="keyword">int</span> mode)</span> <span class="keyword">throws</span> IOException</span>;
    ...
}
</code></pre><p>映射是通过JNI方法<code>native_mmap</code>来进行的，它的实现是在<code>android_os_MemoryFile.cpp</code>:</p>
<pre><code><span class="keyword">static</span> jint android_os_MemoryFile_mmap(<span class="type">JNIEnv</span> * env, jobject clazz, jobject, jobject fileDescriptor jint length, jint prot) {
    <span class="type">int</span> fd = jniGetFDFromFileDescriptor(env, fileDescriptor);
    jint <span class="literal">result</span> = (jint)mmap(<span class="type">NULL</span>, length, prot, <span class="type">MAP_SHARED</span>, fd, <span class="number">0</span>);
    <span class="keyword">if</span> (!<span class="literal">result</span>) {
        jniThrowException(env, <span class="string">"java/io/IOException"</span>, <span class="string">"mmap failed"</span>);
    }
    <span class="keyword">return</span> <span class="literal">result</span>;
}
</code></pre><p>fd是在签名open匿名设备文件/dev/ashmem获得的， 有这个文件描述符后，就可以直接通过mmap来执行内存映射操作了。最后调用进入到Ashmem驱动程序的<code>ashmem_mmap</code>函数中：</p>
<pre><code><span class="keyword">static</span> <span class="keyword">int</span> ashmem_mmap(<span class="keyword">struct</span> file *file, <span class="keyword">struct</span> vm_area_struct *vma) {
    <span class="keyword">struct</span> ashmem_area *asma = file -&gt; private_data;
    <span class="keyword">int</span> ret = <span class="number">0</span>;
    mutex_lock(&amp;ashmem_mutex);

    <span class="comment">//</span>
    <span class="keyword">if</span> (unlikely(!asma-&gt;size)) {
        rt = -EINVAL;
        goto out;
    }
    <span class="comment">//</span>
    <span class="keyword">if</span> (unlikely((vma-&gt;vm_falags &amp; ~asma-&gt;prot_mask) &amp; PROT_MASK)) {
        ret = -EPERM;
        goto out;
    }
    <span class="comment">/*requested protection bits must match our allowed protection mask*/</span>
    <span class="keyword">if</span> (!asma-&gt; file) {
        <span class="keyword">char</span> *name = ASHMEM_NAME_DEF;
        <span class="keyword">struct</span> file *vmfile;
        <span class="comment">//</span>
        <span class="keyword">if</span> (asma-&gt;name[ASHMEM_NAME_PREFIX_LEN] != <span class="string">'\0'</span>)
            name = asma -&gt; name;
        <span class="comment">/* 主要函数 ...and allocate the backing shmem file */</span>
        vmfile = shmem_file_setup(name, asma-&gt;size, vma-&gt;vm_flags);
        <span class="keyword">if</span> (unlikely(IS_EFR(vmfile))) {
            ret = PTR_ERR(vmfile);
            goto out;
        }
        asma-&gt;file = vmfile;
    }
    get_file(asma-&gt;file);
    <span class="keyword">if</span> (vma-&gt;vm_flags &amp; VM_SHARED)
        shmem_set_file(vma, asma-&gt;file);
    <span class="keyword">else</span> {
        <span class="keyword">if</span> (vma-&gt;vm_file)
            fput(vma-&gt;vm_file)
        vma-&gt;vm_file = asma-&gt;file;
    }
    vma-&gt;vm_flags |= VM_CAN_NONLINEAR;
out:
    mutex_unlock(&amp;ashmem_mutex);
    <span class="keyword">return</span> ret;
}
</code></pre><p>调用了Linux 内核提供的shmem_file_setup 函数来在临时文件系统tmpfs中创建一个临时文件a，<br>a与Ashmem驱动程序创建的匿名共享内存对应。</p>
<blockquote>
<p>Linux 内核中的共享内存机制其实是一种进程间通信机制(IPC)</p>
</blockquote>
<p>通过<code>shmem_file_setup</code>函数创建的临时文件vmfile最终保存在vma-&gt;file中。<br>vma是<code>struct vm_area_struct</code>类型，表示的是当前进程空间中一块连续的虚拟地址空间</p>
<p>同时这个临时文件<code>vmfile</code>也会保存在<code>asma-&gt;file</code>域中， 这样<code>Ashmem</code>驱动程序就可以通过<br><code>asma-&gt;file</code>来操作这个匿名共享文件了。</p>
<p>函数<code>ashmem_mmap</code>执行完成后，经过层层返回到JNI方法<code>native_mmap</code>中去，后面，共享内存的读写操作就是对这个地址空间进行操作了。</p>
<h4 id="匿名共享内存的读写操作">匿名共享内存的读写操作</h4><p><code>MemoryFile</code>的匿名共享内存读写操作都是通过JNI方法来实现的，读操作和写操作的JNI方法分别是： <code>native_read</code>和<code>native_write</code>.</p>
<p>因为前面的mmap得到了文件的地址，所以可直接进行访问，不必进入到Ashmem驱动程序中去。<br>这也是<code>Ashmem</code>没有提供<code>read</code>和<code>write</code>文件操作的原因.</p>
<p>其中利用到了<code>ashmem_pin_region</code>和<code>ashmem_unpin_region</code>两个函数是系统运行时库提供的接口，用来执行匿名共享内存的锁定和解锁操作。</p>
<h4 id="匿名共享内存的锁定和解锁">匿名共享内存的锁定和解锁</h4><p>它们的作用是告诉Ashmem驱动程序，它的哪些内存块是正在使用的，需要锁定，哪些内存是不需要使用了，可以让它解锁。<br>这样，Ashmem驱动程序就可以辅助内存管理系统来有效地管理内存了<br>实现在<code>system/core/libcutils/ashmem/ashmem-dev.c</code>文件中：</p>
<pre><code><span class="typename">int</span> ashmem_pin_region(<span class="typename">int</span> fd, size_t offset, size_t <span class="built_in">len</span>) {
    <span class="keyword">struct</span> ashmem_pin pin = { offser, <span class="built_in">len</span> };
    <span class="keyword">return</span> ioctl(fd, ASHMEM_PIN, &amp;pin);
}
<span class="comment">//</span>
<span class="typename">int</span> ashmem_unpin_region(<span class="typename">int</span> fd, size_t offset, size_t <span class="built_in">len</span>) {
    <span class="keyword">struct</span> ashmem_pin pin = { offser, <span class="built_in">len</span> };
    <span class="keyword">return</span> ioctl(fd, ASHMEM_UNPIN, &amp;pin);
}
</code></pre><p>它们的实现很简单，由ASHMEM_PIN和ASHMEM_UNPIN 两个ioctl 操作来实现匿名共享内存的锁定和解锁操作。</p>
<p>它们定义在<code>kernel/common/include/linux/ashmem.h</code>文件中</p>
<pre><code><span class="hexcolor">#def</span>ine __ASHMEMIOC  <span class="number">0</span>x77

<span class="hexcolor">#def</span>ine ASHMEM_PIN    _IOW(__ASHMEMIOC, <span class="number">7</span>, struct ashmem_pin)
<span class="hexcolor">#def</span>ine ASHMEM)UNPIN    _IOW(__ASHMEMIOC, <span class="number">8</span>, struct ashmem_pin)
</code></pre><p>参数类型为<code>struct ashmem_pin</code>, 定义在这个文件下：</p>
<pre><code><span class="class"><span class="keyword">struct</span> <span class="title">ashmem_pin</span> </span>{
    __u32 offset;
    __u32 len;
};
</code></pre><p>这个结构体中只有两个域， 分别表示要锁定或者要解锁的内存块的起始大小以及大小。</p>
<blockquote>
<p>搜索unpinnd</p>
</blockquote>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/20/prepare/jvm/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          JVM 虚拟机
        
      </div>
    </a>
  
  
    <a href="/2016/02/19/prepare/JMM/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Java 内存模型</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="prepare/ashmem" data-title="Ashmem" data-url="http://yoursite.com/2016/03/10/prepare/ashmem/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 chenchen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>