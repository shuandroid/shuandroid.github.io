<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>JVM 虚拟机 | chenchen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="JVM (Java Virtual Machine) java 虚拟机">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM 虚拟机">
<meta property="og:url" content="http://yoursite.com/2016/03/20/prepare/jvm/index.html">
<meta property="og:site_name" content="chenchen">
<meta property="og:description" content="JVM (Java Virtual Machine) java 虚拟机">
<meta property="og:updated_time" content="2016-04-05T01:40:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JVM 虚拟机">
<meta name="twitter:description" content="JVM (Java Virtual Machine) java 虚拟机">
  
    <link rel="alternative" href="/atom.xml" title="chenchen" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://news.mydrivers.com/Img/20100622/10062490.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">chenchen</a></h1>
		</hgroup>

		
		<p class="header-subtitle">be all you can be.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/shuandroid" title="github">github</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 16px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 18px;">Android</a> <a href="/tags/Art/" style="font-size: 12px;">Art</a> <a href="/tags/Ashmem/" style="font-size: 10px;">Ashmem</a> <a href="/tags/DPI/" style="font-size: 10px;">DPI</a> <a href="/tags/JVM/" style="font-size: 12px;">JVM</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Library/" style="font-size: 10px;">Library</a> <a href="/tags/Mvvm/" style="font-size: 10px;">Mvvm</a> <a href="/tags/Network/" style="font-size: 14px;">Network</a> <a href="/tags/RecyclerView/" style="font-size: 10px;">RecyclerView</a> <a href="/tags/Style/" style="font-size: 10px;">Style</a> <a href="/tags/Suooprt/" style="font-size: 10px;">Suooprt</a> <a href="/tags/adapter/" style="font-size: 10px;">adapter</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/android，-Network，-volley，-first/" style="font-size: 10px;">android， Network， volley， first</a> <a href="/tags/anim/" style="font-size: 10px;">anim</a> <a href="/tags/animation/" style="font-size: 12px;">animation</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/design/" style="font-size: 12px;">design</a> <a href="/tags/fourth/" style="font-size: 10px;">fourth</a> <a href="/tags/frame/" style="font-size: 10px;">frame</a> <a href="/tags/git-多分支/" style="font-size: 10px;">git 多分支</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/list/" style="font-size: 10px;">list</a> <a href="/tags/material-design/" style="font-size: 10px;">material design</a> <a href="/tags/mk/" style="font-size: 10px;">mk</a> <a href="/tags/netWork/" style="font-size: 10px;">netWork</a> <a href="/tags/recycler/" style="font-size: 10px;">recycler</a> <a href="/tags/resource/" style="font-size: 10px;">resource</a> <a href="/tags/second/" style="font-size: 10px;">second</a> <a href="/tags/square/" style="font-size: 10px;">square</a> <a href="/tags/third/" style="font-size: 10px;">third</a> <a href="/tags/view/" style="font-size: 14px;">view</a> <a href="/tags/volley/" style="font-size: 14px;">volley</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a> <a href="/tags/ybook/" style="font-size: 10px;">ybook</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">做好眼前的事</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">chenchen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://news.mydrivers.com/Img/20100622/10062490.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">chenchen</h1>
			</hgroup>
			
			<p class="header-subtitle">be all you can be.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/shuandroid" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-prepare/jvm" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/20/prepare/jvm/" class="article-date">
  	<time datetime="2016-03-20T08:34:30.000Z" itemprop="datePublished">2016-03-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      JVM 虚拟机
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Art/">Art</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JVM_(Java_Virtual_Machine)_java_虚拟机">JVM (Java Virtual Machine) java 虚拟机</h1><a id="more"></a>
<h2 id="第二章_java_内存区域与内存溢出">第二章 java 内存区域与内存溢出</h2><p>java 虚拟机运行时数据区：</p>
<ol>
<li><p>线程共享区：</p>
<ul>
<li>方法区： java</li>
<li>堆Heap</li>
</ul>
</li>
<li><p>线程隔离的数据区(线程私有)：</p>
<ul>
<li>虚拟机栈(VM Stack)</li>
<li>本地方法栈(Native Method Stack)</li>
<li>程序计数器(Program Counter Register)</li>
</ul>
</li>
</ol>
<p><strong>程序计数器</strong><br>是一块较小的内存空间， 线程私有。</p>
<blockquote>
<p>当前线程所执行的字节码的行号指示器。<br>此内存区域是唯一一个在java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。</p>
</blockquote>
<p>如果线程正在执行一个java方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；<br>如果执行的是Native方法，这个计数器则为空。</p>
<p><strong>java 虚拟机栈</strong><br>也是线程私有的，它的生命周期和线程同步，描述的是Java方法执行的内存模型：<br>每个方法在执行的同时都会创建一个栈帧(<code>Stack Frame</code>)用于存储<code>局部变量表</code>、操作数栈、<br>动态链接、方法出口等信息。</p>
<blockquote>
<p>每一个方法从调用直至执行难个完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程<br>局部变量表：存放了编译期间可知的各种基本数据类型、对象引用（reference类型，它不等同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是一个句柄或其他与此对象相关的位置）和<br><code>returnAddress</code>类型</p>
</blockquote>
<p>在java虚拟机规范中：对这个区域规定了两种异常状况：</p>
<ol>
<li>如果线程请求的栈深度大于虚拟机所允许的深度，将抛出<code>StackOverflowError</code>异常；</li>
<li>如果虚拟机栈可以动态扩展，如果扩展时无法申请到足够的内存，就会抛出<code>OutOfMemoryError</code>异常</li>
</ol>
<p><strong>本地方法栈</strong><br>native method stack 与虚拟机栈所发挥的作用是非常相似的，它们之间的区别不过是虚拟机栈<br>为虚拟机执行java方法(也就是字节码)服务， 而本地方法栈则为虚拟机所使用的Native方法服务。</p>
<blockquote>
<p>也会抛出StackOverflow 和 OutOfMemoryError 异常</p>
</blockquote>
<p><strong>Java 堆</strong><br>线程共享， java堆(Java Heap)是java 虚拟机所管理的内存中最大的一块。<br>此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。</p>
<blockquote>
<p>java 堆是垃圾收集器的主要区域，GC(Garbage Collected Heap)堆.<br>收集器采用分代收集算法，所有java堆还分为：新生代和老生代<br>如果在堆中没有内存完成实例分配，并且堆也无法再扩展，将会抛出<code>OutOfMemoryError</code>异常</p>
</blockquote>
<p><strong>方法区</strong><br>方法区(Method Area) 与java堆一样，是线程共享的内存区域。<br>用于储存已被虚拟机加载的类信息、常量、静态变量、即时编译后的代码等数据。<br>有一个别名叫做Non-Heap（非堆），目的是与java堆区分开。<br>在HotSpot虚拟机上被称为(永生代)，其实不等价</p>
<p><strong>运行时常量池</strong></p>
<blockquote>
<p>waiting</p>
</blockquote>
<h2 id="第三章:">第三章:</h2><h4 id="3-6-4_动态对象年龄判定">3.6.4 动态对象年龄判定</h4><h4 id="3-6-5_空间分配担保">3.6.5 空间分配担保</h4><blockquote>
<p>主要内容：介绍了垃圾收集算法， 垃圾收集器特点以及运作原理，<br>通过代码实例验证了，java虚拟机中自动内存分配及回收的主要规则</p>
</blockquote>
<h2 id="第四章：_虚拟机性能监控与故障处理工具">第四章： 虚拟机性能监控与故障处理工具</h2><p>java 与C++ 之间有一个有内存动态分配和垃圾收集技术所围成的“高墙”，墙外面的人想进去，墙里面的人想出来。</p>
<h3 id="4-1_概述：">4.1 概述：</h3><p>实践去了解虚拟机内存管理的世界</p>
<h3 id="4-2_JDK的命令行工具">4.2 JDK的命令行工具</h3><p>JDK的bin目录下，有很多命令</p>
<h4 id="4-2-1_jps:_虚拟机进程状况工具">4.2.1 jps: 虚拟机进程状况工具</h4><p>jps: (JVM Process Status Tool),可以列出正在运行的虚拟机进程，并显示虚拟机执行主类(Main Class, main() 函数所在的类)名称以及这些进程的本地虚拟机唯一的ID(Local Virtual Machine Identifier, LVMID).</p>
<pre><code><span class="comment">//jps 命令格式</span>
jps [ options ] [ hostid ]
<span class="comment">// jps 执行样例</span>
D:\Develop\Java\jdk1.<span class="number">6.0</span>_21\bin&gt; jps -<span class="number">1</span>
<span class="number">2388</span> D:\Develop\glassfish\bin\..\modules\admin-cli<span class="class">.jar</span>
<span class="number">2764</span> com<span class="class">.sun</span><span class="class">.enterprise</span><span class="class">.glassfish</span><span class="class">.bootstrap</span><span class="class">.ASMain</span>
<span class="number">3788</span> sun<span class="class">.tools</span><span class="class">.jps</span><span class="class">.Jps</span>
</code></pre><p>jps 可以通过RMI协议查询开启了RMI服务的远程虚拟机进程状态，hostid为RMI注册表中注册的主机名。 jps 的其他常用选项如下：</p>
<ol>
<li>-q : 只输出LVMID， 省略主类的名称</li>
<li>-m : 输出虚拟机进程启动时传递给主类main()函数的参数</li>
<li>-l : 输出主类的全名，如果进程执行的是Jar包， 输出Jar包， 输出Jar路径</li>
<li>-v : 输出虚拟机进程启动时JVM参数</li>
</ol>
<h4 id="4-2-2_jstat:_虚拟机统计信息监视工具">4.2.2 jstat: 虚拟机统计信息监视工具</h4><p>jstat (JVM Statics Monitoring Tool) 用于监视虚拟机各种运行状态信息的命令行工具。</p>
<p>jstat 命令格式为：</p>
<pre><code>jstat <span class="comment">[ option vmid <span class="comment">[interval<span class="comment">[s|ms]</span> <span class="comment">[count]</span>]</span> ]</span>
</code></pre><h3 id="12-4_java_与线程">12.4  java 与线程</h3><p>线程的引入可以把一个进程的资源分配和执行调度分开，各个线程既可以共享进程资源（内存地址、文件I/O等），又可以独自调度。（线程是CPU调度的基本单位）。</p>
<p>实现线程主要有三种方式：使用内核线程实现、使用用户线程实现和使用用户线程加轻量级混合实现。</p>
<ol>
<li>使用内核线程实现</li>
</ol>
<p>内核线程</p>
<h2 id="第三章_垃圾收集器与内存分配策略">第三章 垃圾收集器与内存分配策略</h2><p>在堆里面存放着java世界中几乎所有的对象实例，垃圾收集器在对堆进行回收前，第一件事情就是确定哪些对象还存活着，哪些已经死去。<br><strong>引用计数法</strong><br>给对象中添加一个引用计数器，每当有一个地方引用它时，计数器值就加1；当引用失效时，计数器值就减1；所以，计数器为0的对象就是不可能再被使用的。<br>但它很难解决对象之间的相互循环引用问题，所以主流的java虚拟机并没有采用引用计数方法来管理内存。<br><strong>可达性分析算法</strong><br>在java语言中，可作为GCRoots 的对象包括下面几种：</p>
<ol>
<li>虚拟机栈中引用的对象</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>本地方法栈中JNI(java Native Interface)（即一般说的native 方法）引用的对象。</li>
</ol>
<h4 id="再谈引用">再谈引用</h4><p>判断对象是否存活都与“引用”有关。<br>将引用分为强引用、软引用、弱引用、虚引用：</p>
<ol>
<li>强引用，就是普通的引用<br> 只要强引用还在，垃圾收集器永远不会回收掉被引用的对象</li>
<li>软引用是用来描述一些还有但并非必须的对象。<br> 对于软引用关联着的对象，在系统将要发生内存溢出异常之前，将会把这些对象列进回收范围之中进行第二次回收，如果这次回收还是没有足够的内存，才会抛出内存溢出异常。利用<code>SoftReference</code>类来实现软引用</li>
<li>弱引用<br> 被弱引用关联的对象只能生存到下一次垃圾收集之前。无论当前内存是否足够，都会回收掉只被弱引用关联的对象。<code>WeakReference</code></li>
<li>虚引用<br> 一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。为一个对象设置虚引用关联的唯一目的就是能在这个对象被收集回收时收到一个系统通知。</li>
</ol>
<h4 id="回收方法区">回收方法区</h4><p>其实方法区是有垃圾回收的，主要回收两部分内容： 废弃常量和无用的类。<br>废弃常量<br>无用的类：条件</p>
<ol>
<li>该类所有的实例都已经被回收，也就是java堆中不存在该类的任何实例</li>
<li>加载该类的ClassLoader 已经被回收</li>
<li>该类对应的java.lang.Class 对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</li>
</ol>
<h3 id="垃圾收集算法">垃圾收集算法</h3><h5 id="标记-清除算法">标记-清除算法</h5><p>首先标记出所有需要回收的对象，在标记完成后统一回收所有被标记的对象。主要不足：效率问题，二是空间问题，标记清除后会产生大量不连续的内存碎片，空间碎片太多可能会导致无法找到一块连续的内存，而不得不提前触发一次垃圾收集动作。</p>
<h5 id="复制算法">复制算法</h5><p>将可用内存划分为等大的两块，每次只使用一块，但也存在很多问题</p>
<h5 id="标记-整理算法">标记-整理算法</h5><p>标记过程仍然与标记-清除算法一样，但后续步骤不是直接对可回收对象进行清理，而是让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存。</p>
<h5 id="分代收集算法">分代收集算法</h5><p>一般把java堆分为新生代和老年代，这样就可以根据各个年代的特点采用合适的收集算法。在新生代中，每次垃圾收集都会有大批对象死去，只有少量存活，那就选用复制算法；而老年代中因为对象存活率高、没有额外空间对它进行分配担保，就必须用<code>标记-清理</code>或者<code>标记-整理</code>算法回收。</p>
<h3 id="HotSpot算法实现">HotSpot算法实现</h3><p><strong>枚举根节点</strong><br>java虚拟机使用的都是准确式GC，所以当执行系统停顿下来后，并不需要一个不漏的检查完所有执行上下文和全局的引用位置，虚拟机应当是有办法直接得知哪些地方存放着对象引用，<br>在HotMap的实现中，是使用一组称为OopMap的数据结构来达到这个目的的。</p>
<p><strong>安全点</strong><br>在OopMap的协助下，HotSpot 可以快速且准确的完成GC Roots 枚举，问题是：可能导致引用关系变化，会需要很多OopMap指令，需要大量的额外空间，这样GC的空间成本会变得很高。<br>但事实上，HotSpot并没有为每条指令都生成OopMap,只是在特定的位置记录了这些信息，称为<code>安全点(Safepoint)</code> 程序执行时并非在所有地方都能停顿下开开始GC，只有在到达安全点时才能暂停。<br><strong>安全区域</strong><br>程序“不执行”的时候？就是指没有分配CPU时间，典型的例子就是线程处于sleep状态或者Blocked状态，这时候线程无法响应JVM的中断请求，需要安全区域(Safe Region)来解决。</p>
<h3 id="垃圾收集器">垃圾收集器</h3><p><strong>Serial 收集器</strong></p>
<blockquote>
<p>只会使用一个CPU，一条收集线程<br>在进行垃圾收集时必须暂停其他所有的工作线程。</p>
</blockquote>
<p><strong>PalNew 收集器</strong></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/03/10/prepare/ashmem/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Ashmem</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="prepare/jvm" data-title="JVM 虚拟机" data-url="http://yoursite.com/2016/03/20/prepare/jvm/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 chenchen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>